import {
  Handle,
  Position,
  NodeProps,
  useStore,
  useReactFlow,
  useNodeConnections,
  useNodesData,
  NodeResizer,
} from "@xyflow/react";
import { useState, useRef, useEffect } from "react";
import { useWorkflow } from "../WorkflowContext";
import { toast } from "sonner@2.0.3";
import { ChevronRight, Plus, ScanEye, Minus, Trash2 } from "lucide-react";
import svgPaths from "../../imports/svg-t58ri81i0n";
import {
  generateImage,
  SUPPORTED_MODELS,
} from "../../lib/googleAI";
import { getPresetConfig } from "../../lib/presets";
import NodeToolbar from "./NodeToolbar";

interface InputItem {
  id: string;
  label: string;
  type:
    | "preset"
    | "mode"
    | "image"
    | "model"
    | "number"
    | "aspectRatio"
    | "quality"
    | "text";
  value?: string | number;
}

const defaultInputs: InputItem[] = [
  {
    id: "model",
    label: "Gemini 2.5 Flash",
    type: "model",
    value: "gemini-2.5-flash-image",
  },
  { id: "mode", label: "未添加 预设", type: "mode" },
  { id: "img1", label: "图片1", type: "image" },
  { id: "quantity", label: "数量", type: "number", value: 1 },
  {
    id: "aspectRatio",
    label: "尺寸",
    type: "aspectRatio",
    value: "9:16",
  },
  {
    id: "quality",
    label: "清晰度",
    type: "quality",
    value: "2K",
  },
];

const PRESET_OPTIONS = [
  "图片反推",
  "切换人物视角",
  "建筑图转模型",
  "组合物体",
  "高清修复",
  "图转线稿",
  "按照色卡上色",
  "生成一套角色设定",
  "虚实结合/跨次元",
  "动漫转真人",
  "姿势参考",
  "图片转人偶玩具",
  "图片转 Funko Pop",
  "图片转乐高",
  "图片转芭比娃娃",
  "万物变高达",
  "赛博生娃",
  "产品设计图转渲染",
  "秒变专业摄影大片",
  "光影参考",
  "生成绘画过程",
  "任何风格变写实",
  "图片变挂件",
  "指定效果叠加",
  "产品包装贴合",
  "虚拟试妆",
  "表情参考",
];

export default function ImageEditorNode({
  data,
  id,
  selected,
}: NodeProps) {
  const [inputs, setInputs] = useState<InputItem[]>(() => {
    // Merge default inputs with incoming data inputs if available
    if (data.inputs && Array.isArray(data.inputs)) {
       // Start with non-dynamic defaults (model, quantity, etc)
       const baseInputs = defaultInputs.filter(i => ["model", "quantity", "aspectRatio", "quality", "mode"].includes(i.type));
       const incomingImages = data.inputs.filter((i: any) => i.type === "image");
       // If no images in incoming, use default img1
       if (incomingImages.length === 0) {
           return defaultInputs;
       }
       // Replace default image with incoming images
       const images = incomingImages.map((i: any) => ({...i, id: i.id || `img-${Date.now()}-${Math.random()}`}));
       
       // Sort order: Model -> Mode -> Images -> Text (separate) -> Params
       // We'll manage text separately or as a fixed input
       return [
           ...baseInputs.filter(i => i.type === "model"),
           ...baseInputs.filter(i => i.type === "mode"),
           ...images,
           ...baseInputs.filter(i => ["quantity", "aspectRatio", "quality"].includes(i.type))
       ];
    }
    return defaultInputs;
  });

  const { isProcessing, setIsProcessing, setProcessedImage } = useWorkflow();
  const { addNodes, addEdges, getNode } = useReactFlow();
  const [showAddMenu, setShowAddMenu] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  const connections = useNodeConnections({
    handleType: "target",
    handleId: "text-input",
  });

  const nodeData = useNodesData(connections?.[0]?.source);
  const connectedText =
    (nodeData?.data?.label as string) ||
    (nodeData?.data?.text as string) ||
    "";

  const edges = useStore((state: any) => state.edges);
  const [activePopup, setActivePopup] = useState<string | null>(null);
  const [promptText, setPromptText] = useState<string>("");

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (
        menuRef.current &&
        !menuRef.current.contains(event.target as Node)
      ) {
        setShowAddMenu(false);
      }
      if ((event.target as Element).closest(".popup-container") === null) {
          setActivePopup(null);
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () =>
      document.removeEventListener(
        "mousedown",
        handleClickOutside,
      );
  }, []);

  const isHandleConnected = (
    handleId: string | null,
    type: "source" | "target",
  ) => {
    return edges.some((e: any) => {
      if (type === "target") {
        return e.target === id && e.targetHandle === handleId;
      } else {
        return e.source === id;
      }
    });
  };

  const handleAddInput = () => {
    const newInputId = `img-${Date.now()}`;
    const newInput: InputItem = {
      id: newInputId,
      label: `图片${inputs.filter((i) => i.type === "image").length + 1}`,
      type: "image",
    };
    
    // Insert after the last image input
    const lastImageIndex = inputs.findLastIndex(i => i.type === "image");
    const insertIndex = lastImageIndex === -1 ? 2 : lastImageIndex + 1; // Default after Mode if no images
    
    const newInputs = [...inputs];
    newInputs.splice(insertIndex, 0, newInput);
    setInputs(newInputs);
    setShowAddMenu(false);
  };

  const handleDeleteInput = (inputId: string) => {
    const imageInputs = inputs.filter((i) => i.type === "image");
    if (imageInputs.length <= 1) {
      toast.error("至少保留一个图片输入");
      return;
    }
    setInputs(inputs.filter((i) => i.id !== inputId));
  };

  const handleModelSelect = (inputId: string, modelId: string, modelLabel: string) => {
    setInputs(inputs.map(i => i.id === inputId ? { ...i, label: modelLabel.split(" (")[0], value: modelId } : i));
    setActivePopup(null);
  };

  const handlePresetSelect = (inputId: string, newValue: string) => {
      setInputs(inputs.map(i => i.id === inputId ? { ...i, label: newValue } : i));
      
      const configs = require("../../lib/presets").PRESET_CONFIGS;
      const entry = Object.entries(configs).find(([_, config]: [string, any]) => config.label === newValue);
      if (entry) {
          const config = entry[1] as any;
          setPromptText(config.prompt || "");
          toast.success(`已应用预设: ${newValue}`);
      }
      setActivePopup(null);
  };
  
  const handleNumberChange = (inputId: string, delta: number) => {
    setInputs(inputs.map(i => {
        if (i.id === inputId) {
            const val = Number(i.value) || 1;
            return { ...i, value: Math.max(1, Math.min(10, val + delta)) };
        }
        return i;
    }));
  };

  const handleRun = async () => {
      if (isProcessing) return;
      setIsProcessing(true);
      try {
          const modelInput = inputs.find(i => i.type === "model");
          const quantityInput = inputs.find(i => i.type === "number");
          const aspectRatioInput = inputs.find(i => i.type === "aspectRatio");
          const qualityInput = inputs.find(i => i.type === "quality");
          const imageInputs = inputs.filter(i => i.type === "image");
          
          // Collect image data from connected nodes and convert to ImagePart format
          const connectedImages = [];
          for (const imgInput of imageInputs) {
              const connection = edges.find((e: any) => e.target === id && e.targetHandle === imgInput.id);
              if (connection) {
                  const sourceNode = getNode(connection.source);
                  if (sourceNode?.data?.output) {
                       // Convert base64 string to ImagePart format
                       const imageData = sourceNode.data.output;
                       // If it's already a base64 string, extract it
                       const base64Data = imageData.startsWith('data:') 
                           ? imageData.split(',')[1] 
                           : imageData;
                       const mimeType = imageData.startsWith('data:') 
                           ? imageData.split(';')[0].split(':')[1] 
                           : 'image/png';
                        
                       connectedImages.push({
                           base64: base64Data,
                           mimeType: mimeType
                       });
                   }
              }
          }
          
          const prompt = isHandleConnected("text-input", "target") ? connectedText : promptText;
          
          if (!prompt && connectedImages.length === 0) {
              toast.error("请输入提示词或连接图片");
              return;
          }

          // Map quality to imageSize for gemini-3-pro-image-preview
          const qualityMap: Record<string, '1K' | '2K' | '4K'> = {
              'SD': '1K',
              'HD': '2K',
              '2K': '2K',
              '4K': '4K'
          };

          console.log("Starting image generation with:");
          console.log("Model:", modelInput?.value);
          console.log("Prompt:", prompt || "Generate a beautiful image");
          console.log("Connected images:", connectedImages.length);
          console.log("Aspect ratio:", aspectRatioInput?.value || "9:16");
          console.log("Image size:", qualityMap[qualityInput?.value as string] || '2K');

          const result = await generateImage(
              connectedImages, // First parameter: images array
              prompt || "Generate a beautiful image", // Second parameter: prompt
              {
                  imageWeight: 80,
                  aspectRatio: aspectRatioInput?.value as string || "9:16",
                  model: modelInput?.value as string || "gemini-2.5-flash-image",
                  imageSize: qualityMap[qualityInput?.value as string] || '2K'
              }
          );
          
          console.log("Generation result received:", result ? "Success" : "Failed");
          console.log("Result type:", typeof result);
          console.log("Result length:", result ? result.length : 0);
          
          // Save the generated image to processedImages
          if (result) {
            setProcessedImage(id, result);
            // Also save to node data for compatibility
            const currentNode = getNode(id);
            if (currentNode) {
              // We'll update the node data indirectly through the workflow context
              // This ensures both processedImages and node data are synchronized
              console.log("Image generated successfully and stored in processedImages");
            }
            toast.success("生成完成！");
          } else {
            toast.error("生成失败：未返回有效的图片数据");
          }
          
      } catch (error: any) {
          console.error("Generation error:", error);
          const errorMessage = error?.message || "生成失败";
          toast.error(errorMessage);
      } finally {
          setIsProcessing(false);
      }
  };

  return (
    <>
      <NodeResizer
        color="transparent"
        handleClassName="opacity-0 hover:opacity-100 transition-opacity"
        handleStyle={{ width: 8, height: 8, borderRadius: 2, border: "1px solid var(--primary)", backgroundColor: "var(--background)" }}
        lineStyle={{ borderWidth: 1, borderColor: "var(--primary)", opacity: 0.5 }}
        isVisible={selected}
        minWidth={214}
        minHeight={200}
      />
      {selected && (
        <div className="absolute top-[-40px] left-1/2 -translate-x-1/2 z-50">
          <NodeToolbar nodeId={id} />
        </div>
      )}

      <div className="bg-card flex flex-col gap-2 items-start p-1 relative rounded-[var(--radius)] w-[214px] group">
        <div aria-hidden="true" className="absolute border border-border border-solid inset-0 pointer-events-none rounded-[var(--radius)]" />
        
        {/* Main Inputs Container */}
        <div className="flex flex-col gap-1 items-start relative shrink-0 w-full">
            
            {/* Model Input */}
            {inputs.filter(i => i.type === "model").map(item => (
                <div key={item.id} className="relative w-full z-20">
                    <div 
                        className="bg-secondary h-[32px] relative rounded-[var(--radius-sm)] shrink-0 w-full cursor-pointer hover:bg-muted transition-colors"
                        onClick={(e) => { e.stopPropagation(); setActivePopup(activePopup === item.id ? null : item.id); }}
                    >
                        <div className="flex flex-row items-center justify-center size-full">
                            <div className="content-stretch flex gap-1.5 items-center justify-center px-2.5 py-1 relative size-full">
                                <div className="content-stretch flex items-center justify-center overflow-clip p-[2px] relative shrink-0 size-[16px]">
                                    <div className="relative shrink-0 size-[9px]">
                                        <svg className="block size-full" fill="none" viewBox="0 0 10.5 10.5">
                                            <path d="M0.75 0.75L3.75 3.75" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                            <path d="M6.75 3.75L9.75 0.75" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                            <path d="M0.75 9.75L3.75 6.75" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                            <path d="M6.75 6.75L9.75 9.75" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                        </svg>
                                    </div>
                                </div>
                                <div className="flex flex-[1_0_0] flex-col justify-center leading-[0] min-h-px min-w-px relative text-foreground text-[length:var(--text-p)] font-medium tracking-[-0.16px]">
                                    <p className="leading-[16.5px] whitespace-pre-wrap">{item.label}</p>
                                </div>
                                <div className={`flex items-center justify-center relative shrink-0 size-[12px] transition-transform duration-200 ${activePopup === item.id ? "rotate-0" : "-rotate-90"}`}>
                                    <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                        <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    {activePopup === item.id && (
                        <div className="absolute left-[calc(100%+8px)] top-0 w-[200px] bg-card border border-border/20 rounded-[16px] p-[8px] flex flex-col gap-[4px] z-50 popup-container">
                            {SUPPORTED_MODELS.map(m => (
                                <div key={m.id} className="text-[length:var(--text-p)] px-3 py-2 hover:bg-muted rounded-md cursor-pointer text-foreground" onClick={(e) => { e.stopPropagation(); handleModelSelect(item.id, m.id, m.label); }}>
                                    {m.label}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            ))}

            {/* Mode/Preset Input */}
            {inputs.filter(i => i.type === "mode").map(item => (
                <div key={item.id} className="relative w-full z-10">
                    <div 
                        className="bg-secondary h-[32px] relative rounded-[var(--radius-sm)] shrink-0 w-full cursor-pointer hover:bg-muted transition-colors"
                        onClick={(e) => { e.stopPropagation(); setActivePopup(activePopup === item.id ? null : item.id); }}
                    >
                         <div className="flex flex-row items-center justify-center size-full">
                            <div className="content-stretch flex gap-1.5 items-center justify-center px-2.5 py-1 relative size-full">
                                <div className="content-stretch flex flex-col items-center justify-center relative shrink-0 size-[16px]">
                                    <div className="h-[12.25px] relative shrink-0 w-[18.083px] flex items-center justify-center">
                                         <svg className="block w-[14px] h-[10px]" fill="none" viewBox="0 0 18.0833 12.25">
                                            <circle cx="5.54167" cy="2.33333" r="1.58333" stroke="currentColor" strokeWidth="1.5" />
                                            <circle cx="12.5417" cy="9.91667" r="1.58333" stroke="currentColor" strokeWidth="1.5" />
                                            <path d={svgPaths.p202fa00} stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                        </svg>
                                    </div>
                                </div>
                                <div className="flex flex-[1_0_0] flex-col justify-center leading-[0] min-h-px min-w-px relative text-[length:var(--text-p)] font-medium text-muted-foreground">
                                    <p className="leading-[16.5px] whitespace-pre-wrap text-foreground">{item.label}</p>
                                </div>
                                <div className="relative shrink-0 size-[12px]">
                                    <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                        <path d="M2.49998 6H9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                        <path d="M6 2.49998V9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                     {activePopup === item.id && (
                        <div className="absolute left-[calc(100%+8px)] top-0 w-[200px] bg-card border border-border/20 rounded-[var(--radius)] p-2 flex flex-col gap-1 z-50 popup-container max-h-[300px] overflow-y-auto hide-scrollbar">
                            {PRESET_OPTIONS.map(opt => (
                                <div key={opt} className="text-[length:var(--text-p)] px-3 py-2 hover:bg-muted rounded-md cursor-pointer truncate text-foreground" onClick={(e) => { e.stopPropagation(); handlePresetSelect(item.id, opt); }}>
                                    {opt}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            ))}

            {/* Image Inputs */}
            {inputs.filter(i => i.type === "image").map(item => (
                <div key={item.id} className="content-stretch flex items-center justify-center relative rounded-[var(--radius-sm)] shrink-0 w-full">
                     <div className="bg-secondary flex-[1_0_0] h-[32px] min-h-px min-w-px relative rounded-[var(--radius-sm)]">
                        <div className="flex flex-row items-center justify-end size-full">
                            <div className="content-stretch flex gap-1.5 items-center justify-end px-2.5 py-1 relative size-full">
                                <div className="content-stretch flex items-center justify-center relative shrink-0 size-[16px]">
                                    <div className="relative shrink-0 size-[14.4px]">
                                        <svg className="block size-full" fill="none" viewBox="0 0 14.4 14.4">
                                            <path clipRule="evenodd" d={svgPaths.p2cec1fc0} fill="currentColor" fillRule="evenodd" />
                                            <path d={svgPaths.p33dfc580} stroke="currentColor" strokeWidth="0.9" />
                                            <path d={svgPaths.pa9a9200} fill="currentColor" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="0.9" />
                                        </svg>
                                    </div>
                                </div>
                                <div className="flex flex-[1_0_0] flex-col justify-center leading-[0] min-h-px min-w-px overflow-hidden relative text-foreground text-[length:var(--text-p)] font-medium text-ellipsis whitespace-nowrap">
                                    <p className="leading-[16.5px] overflow-hidden">{item.label}</p>
                                </div>
                                <div 
                                    className="content-stretch flex h-[12px] items-center opacity-40 overflow-clip px-[2.25px] py-[1.5px] relative shrink-0 cursor-pointer hover:opacity-100"
                                    onClick={(e) => { e.stopPropagation(); handleDeleteInput(item.id); }}
                                >
                                    <div className="h-[9px] relative shrink-0 w-[7.5px]">
                                        <div className="absolute inset-[-5.56%_-16.67%]">
                                            <svg className="block size-full" fill="none" viewBox="0 0 10 10">
                                                <path d="M3.875 0.5H6.125" stroke="currentColor" strokeLinecap="round" />
                                                <path d="M0.5 2H9.5" stroke="currentColor" strokeLinecap="round" />
                                                <path d={svgPaths.p23780380} stroke="currentColor" strokeLinecap="round" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="absolute left-[-12px] top-1/2 -translate-y-1/2 z-30">
                                   <Handle
                                      type="target"
                                      position={Position.Left}
                                      id={item.id}
                                      className={`!w-[16px] !h-[16px] !border-[1.5px] !border-card !bg-primary !rounded-full opacity-100`}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ))}

            {/* Add Image Button */}
            <div className="content-stretch flex items-center justify-center relative rounded-[var(--radius-sm)] shrink-0 w-full">
                <div 
                    className="bg-secondary flex-[1_0_0] h-[32px] min-h-px min-w-px relative rounded-[var(--radius-sm)] cursor-pointer hover:bg-muted transition-colors"
                    onClick={handleAddInput}
                >
                    <div className="flex flex-row items-center justify-center size-full">
                        <div className="content-stretch flex gap-1.5 items-center justify-center px-2.5 py-1 relative size-full">
                            <div className="flex flex-col justify-center leading-[0] relative shrink-0 text-[length:var(--text-p)] font-medium text-muted-foreground whitespace-nowrap">
                                <p className="leading-[16.5px]">图片</p>
                            </div>
                            <div className="relative shrink-0 size-[12px] opacity-40">
                                <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                    <path d="M2.49998 6H9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                    <path d="M6 2.49998V9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Text Input */}
             <div className="bg-secondary h-[97px] relative rounded-[var(--radius-sm)] shrink-0 w-full mt-1">
                <div className="flex flex-col items-end justify-center size-full">
                    <div className="content-stretch flex flex-col items-end justify-center p-3 relative size-full">
                        <div className="content-stretch flex flex-[1_0_0] flex-col items-start min-h-px min-w-px relative w-full">
                            {isHandleConnected("text-input", "target") ? (
                                <div className="text-[length:var(--text-p)] text-foreground leading-[1.5] w-full h-full overflow-hidden whitespace-pre-wrap opacity-60">
                                    {connectedText}
                                </div>
                            ) : (
                                <textarea
                                    value={promptText}
                                    onChange={(e) => setPromptText(e.target.value)}
                                    className="w-full h-full bg-transparent border-none outline-none resize-none text-[length:var(--text-p)] leading-[1.5] placeholder:text-muted-foreground text-foreground"
                                    placeholder="Enter text …"
                                />
                            )}
                        </div>
                    </div>
                </div>
                {/* Text Input Handle - Fixed: Now on Left side and visible */}
                <div className="absolute left-[-12px] top-1/2 -translate-y-1/2 z-30">
                   <Handle
                      type="target"
                      position={Position.Left}
                      id="text-input"
                      className="!w-[16px] !h-[16px] !border-[1.5px] !border-card !bg-primary !rounded-full opacity-100"
                    />
                </div>
            </div>

        </div>

        {/* Divider */}
        <div className="h-[2px] relative shrink-0 w-[206px] my-1">
             <svg className="block size-full" fill="none" viewBox="0 0 206 2">
                <path d="M4 1H202" stroke="currentColor" strokeLinecap="round" strokeOpacity="0.05" />
            </svg>
        </div>

        {/* Parameters */}
        <div className="content-stretch flex flex-col gap-1 items-start relative shrink-0 w-full">
            {inputs.filter(i => ["number", "aspectRatio", "quality"].includes(i.type)).map(item => (
                <div key={item.id} className="content-stretch flex items-center justify-center relative rounded-[var(--radius-sm)] shrink-0 w-full">
                    <div className="bg-secondary flex-[1_0_0] h-[32px] min-h-px min-w-px relative rounded-[var(--radius-sm)]">
                        <div className="flex flex-row items-center justify-end size-full">
                            <div className="content-stretch flex gap-1.5 items-center justify-end px-2.5 py-1 relative size-full">
                                <div className="overflow-clip relative shrink-0 size-[16px]">
                                     <div className="absolute left-1/2 size-[8px] top-1/2 -translate-x-1/2 -translate-y-1/2">
                                         <svg className="block size-full" fill="none" viewBox="0 0 9.5 9.5">
                                            <path d={svgPaths.p38e49700} stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" />
                                        </svg>
                                    </div>
                                </div>
                                <div className="flex flex-[1_0_0] flex-col justify-center leading-[0] min-h-px min-w-px overflow-hidden relative text-foreground text-[length:var(--text-p)] font-medium text-ellipsis whitespace-nowrap">
                                    <p className="leading-[16.5px] overflow-hidden">{item.label}</p>
                                </div>
                                
                                {item.type === "number" ? (
                                    <>
                                        <div className="relative shrink-0 size-[12px] cursor-pointer" onClick={(e) => { e.stopPropagation(); handleNumberChange(item.id, -1); }}>
                                            <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                                <path d="M2.49998 6H9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                            </svg>
                                        </div>
                                        <div className="flex flex-col justify-center leading-[0] not-italic relative shrink-0 text-foreground text-[length:var(--text-p)] font-medium whitespace-nowrap w-[20px] items-center">
                                            <p className="leading-[16.5px]">{item.value}</p>
                                        </div>
                                        <div className="relative shrink-0 size-[12px] cursor-pointer" onClick={(e) => { e.stopPropagation(); handleNumberChange(item.id, 1); }}>
                                            <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                                <path d="M2.49998 6H9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                                <path d="M6 2.49998V9.49998" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                            </svg>
                                        </div>
                                    </>
                                ) : (
                                    <div 
                                        className="flex items-center gap-[6px] cursor-pointer"
                                        onClick={(e) => { e.stopPropagation(); setActivePopup(activePopup === item.id ? null : item.id); }}
                                    >
                                        <div className="flex flex-col justify-center leading-[0] not-italic relative shrink-0 text-foreground text-[length:var(--text-p)] font-medium whitespace-nowrap">
                                            <p className="leading-[16.5px]">{item.value}</p>
                                        </div>
                                        <div className={`flex items-center justify-center relative shrink-0 size-[12px] transition-transform duration-200 ${activePopup === item.id ? "rotate-0" : "-rotate-90"}`}>
                                            <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                                <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" />
                                            </svg>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                     {activePopup === item.id && item.type === "aspectRatio" && (
                        <div className="absolute left-[calc(100%+8px)] top-0 w-[120px] bg-card border border-border/20 rounded-[var(--radius)] p-2 flex flex-col gap-1 z-50 popup-container">
                            {["1:1", "16:9", "9:16", "4:3", "3:4"].map(ratio => (
                                <div key={ratio} className="text-[length:var(--text-p)] px-3 py-2 hover:bg-muted rounded-md cursor-pointer text-foreground" onClick={(e) => { e.stopPropagation(); setInputs(inputs.map(i => i.id === item.id ? { ...i, value: ratio } : i)); setActivePopup(null); }}>
                                    {ratio}
                                </div>
                            ))}
                        </div>
                    )}
                     {activePopup === item.id && item.type === "quality" && (
                        <div className="absolute left-[calc(100%+8px)] top-0 w-[120px] bg-card border border-border/20 rounded-[var(--radius)] p-2 flex flex-col gap-1 z-50 popup-container">
                            {["SD", "HD", "2K", "4K"].map(q => (
                                <div key={q} className="text-[length:var(--text-p)] px-3 py-2 hover:bg-muted rounded-md cursor-pointer text-foreground" onClick={(e) => { e.stopPropagation(); setInputs(inputs.map(i => i.id === item.id ? { ...i, value: q } : i)); setActivePopup(null); }}>
                                    {q}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            ))}
        </div>

        {/* Footer */}
        <div className="h-[32px] relative shrink-0 w-full mt-1">
             <div className="flex flex-row items-center size-full">
                <div className="content-stretch flex gap-[10px] items-center px-[4px] relative size-full">
                     <div className="content-stretch flex gap-[10px] items-center justify-center relative shrink-0 size-[16px]">
                        <div className="absolute h-[1.502px] left-[9px] top-[2px] w-[1.5px]">
                            <svg className="block size-full" fill="none" viewBox="0 0 2.55624 2.55849">
                                <path d={svgPaths.p3e11ff40} stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.05624" />
                            </svg>
                        </div>
                        <div className="absolute h-[1.133px] left-[11px] top-[6px] w-[1.132px]">
                             <svg className="block size-full" fill="none" viewBox="0 0 1.9286 1.9303">
                                <path d={svgPaths.p301a79f2} stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="0.796897" />
                            </svg>
                        </div>
                        <div className="absolute flex items-center justify-center left-[2.52px] size-[10.96px] top-[3.52px]">
                             <div className="-rotate-45 flex-none">
                                <div className="content-stretch flex flex-col gap-px items-center relative w-[2.5px]">
                                     <div className="content-stretch flex items-center justify-center relative shrink-0 size-[4px]">
                                        <div className="flex items-center justify-center relative shrink-0">
                                            <div className="-scale-y-100 flex-none">
                                                <div className="relative rounded-[1px] size-[2.5px]">
                                                    <div aria-hidden="true" className="absolute border-currentColor border-[1.5px] border-solid inset-[-0.75px] pointer-events-none rounded-[1.75px]" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-currentColor h-[8px] rounded-[1px] shrink-0 w-[2px]" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="flex flex-[1_0_0] flex-col justify-center leading-[0] min-h-px min-w-px not-italic relative text-foreground text-[length:var(--text-p)] font-semibold">
                        <p className="leading-[22.5px] whitespace-pre-wrap">Image Editor</p>
                    </div>
                    
                     <div 
                        className="bg-card content-stretch flex items-center justify-center p-2.5 relative rounded-full shrink-0 size-[24px] cursor-pointer hover:scale-105 transition-transform"
                        onClick={(e) => { e.stopPropagation(); handleRun(); }}
                    >
                         <div className="relative shrink-0 size-[12px]">
                            <svg className="block size-full" fill="none" viewBox="0 0 12 12">
                                <path d={svgPaths.p2c610f00} stroke="currentColor" strokeWidth="1.5" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* Global Output Handle */}
        <div className="absolute right-[-24px] top-1/2 -translate-y-1/2 z-30">
             <Handle
                type="source"
                position={Position.Right}
                id="output"
                className={`!w-[16px] !h-[16px] !border-[1.5px] !border-card !bg-primary !rounded-full opacity-100`}
            />
        </div>

      </div>
    </>
  );
}