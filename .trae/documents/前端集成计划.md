# Creativeworkflowapp 前端与 AI-FLOW (ComfyUI) 后端集成计划

## 1. 项目概述

### 1.1 本地项目 (AI-FLOW/ComfyUI)
- **类型**: Python 后端服务
- **功能**: 强大的模块化视觉AI引擎，提供节点/图形界面执行AI工作流
- **技术栈**: Python, PyTorch, FastAPI/AIOHTTP
- **API**: 提供 REST API 和 WebSocket 接口
- **支持模型**: SD1.x/2.x/SDXL, Flux, Hunyuan, Wan, Mochi 等多种图像/视频/音频模型

### 1.2 前端项目 (Creativeworkflowapp)
- **类型**: React + TypeScript 前端应用
- **功能**: 图像生成工作流应用，节点式工作流编辑
- **技术栈**: React 18+, TypeScript, Vite, Tailwind CSS, @xyflow/react, Radix UI
- **当前API**: Google AI SDK, Ark API (火山引擎)

## 2. 集成目标

将 Creativeworkflowapp 作为 AI-FLOW 的替代前端，实现：
1. 前端通过 ComfyUI API 执行工作流
2. 利用 ComfyUI 的本地模型能力
3. 保留 Creativeworkflowapp 的现代 UI 和用户体验
4. 实现工作流的保存/加载/分享

## 3. 集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                   Creativeworkflowapp (前端)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ React UI    │  │ @xyflow/    │  │ ComfyUI API Client  │  │
│  │ Components  │  │ react       │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   AI-FLOW/ComfyUI (后端)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ API Server  │  │ Execution   │  │ Model Management    │  │
│  │ (server.py) │  │ Engine      │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 4. 详细实施步骤

### 阶段一：API 客户端开发 (优先级: 高)

#### 4.1.1 创建 ComfyUI API 客户端
**文件**: `src/lib/comfyuiClient.ts`

功能：
- 连接 ComfyUI 服务器 (默认 http://127.0.0.1:8188)
- 获取可用模型列表
- 执行工作流
- WebSocket 实时进度更新
- 中断执行

#### 4.1.2 ComfyUI API 端点
| 端点 | 方法 | 用途 |
|------|------|------|
| `/prompt` | POST | 提交工作流执行 |
| `/queue` | GET | 获取队列状态 |
| `/interrupt` | POST | 中断当前执行 |
| `/view` | GET | 获取生成的图像 |
| `/upload/image` | POST | 上传图像 |
| `/object_info` | GET | 获取节点类型信息 |
| `/history` | GET | 获取执行历史 |

### 阶段二：工作流转换层 (优先级: 高)

#### 4.2.1 节点映射
将 Creativeworkflowapp 的节点映射到 ComfyUI 节点：

| 前端节点 | ComfyUI 节点 |
|----------|--------------|
| ImageInputNode | LoadImage |
| TextInputNode | CLIPTextEncode |
| ImageEditorNode | KSampler + VAE Decode |
| PreviewNode | SaveImage / PreviewImage |
| CharacterNode | IPAdapter / FaceDetailer |

#### 4.2.2 工作流生成器
**文件**: `src/lib/workflowBuilder.ts`

功能：
- 将前端节点图转换为 ComfyUI 工作流 JSON
- 处理节点连接关系
- 生成正确的输入/输出链接

### 阶段三：UI 组件适配 (优先级: 中)

#### 4.3.1 模型选择器
- 从 ComfyUI 获取可用模型列表
- 支持 checkpoint、LoRA、VAE 等模型类型
- 动态更新模型列表

#### 4.3.2 参数面板
- 适配 ComfyUI 的采样器参数
- 支持 steps, cfg, sampler_name, scheduler 等参数
- 支持图像尺寸设置

#### 4.3.3 进度显示
- WebSocket 实时进度
- 预览图生成
- 执行日志

### 阶段四：配置和环境 (优先级: 中)

#### 4.4.1 环境变量更新
**文件**: `.env.example`

```env
# ComfyUI Configuration
VITE_COMFYUI_API_URL=http://127.0.0.1:8188
VITE_COMFYUI_WS_URL=ws://127.0.0.1:8188

# 保留原有配置（可选）
VITE_SUPABASE_PROJECT_ID=your_project_id
VITE_SUPABASE_ANON_KEY=your_anon_key
```

#### 4.4.2 配置文件更新
**文件**: `src/config.ts`

添加 ComfyUI 相关配置：
- API 基础 URL
- WebSocket URL
- 超时设置
- 重试策略

### 阶段五：状态管理更新 (优先级: 中)

#### 4.5.1 WorkflowContext 更新
- 添加 ComfyUI 客户端实例
- 添加工作流执行状态
- 添加进度跟踪
- 添加错误处理

#### 4.5.2 新增 Context
**文件**: `src/components/ComfyUIContext.tsx`

管理：
- 连接状态
- 可用模型
- 执行队列
- 历史记录

## 5. 文件结构变更

```
/src
  /lib
    comfyuiClient.ts      # 新增: ComfyUI API 客户端
    workflowBuilder.ts    # 新增: 工作流转换器
    googleAI.ts           # 保留: 可选的云端模型支持
  /components
    ComfyUIContext.tsx    # 新增: ComfyUI 状态管理
    ModelSelector.tsx     # 新增: 模型选择器
    ProgressIndicator.tsx # 新增: 执行进度指示器
    /nodes
      ComfyNode.tsx       # 新增: 通用 ComfyUI 节点包装器
```

## 6. API 客户端实现示例

### 6.1 ComfyUI 客户端核心接口

```typescript
interface ComfyUIClient {
  // 连接管理
  connect(): Promise<void>;
  disconnect(): void;
  isConnected(): boolean;
  
  // 工作流执行
  queuePrompt(workflow: ComfyUIWorkflow): Promise<string>;
  interrupt(): Promise<void>;
  getQueue(): Promise<QueueInfo>;
  
  // 模型管理
  getModels(): Promise<ModelList>;
  getObjectInfo(): Promise<ObjectInfo>;
  
  // 图像操作
  uploadImage(file: File): Promise<ImageUploadResult>;
  getImage(filename: string, subfolder?: string): Promise<Blob>;
  
  // WebSocket
  subscribeToProgress(callback: ProgressCallback): void;
  subscribeToExecution(callback: ExecutionCallback): void;
}
```

### 6.2 工作流 JSON 结构

```typescript
interface ComfyUIWorkflow {
  [nodeId: string]: {
    inputs: Record<string, any>;
    class_type: string;
    _meta?: {
      title?: string;
    };
  };
}
```

## 7. 测试计划

### 7.1 单元测试
- API 客户端方法测试
- 工作流转换测试
- 节点映射测试

### 7.2 集成测试
- 端到端工作流执行
- 图像生成测试
- 错误处理测试

### 7.3 手动测试
- UI 交互测试
- 实时进度测试
- 多模型切换测试

## 8. 风险和缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| ComfyUI API 变更 | 高 | 版本锁定，API 适配层 |
| WebSocket 连接不稳定 | 中 | 自动重连，心跳检测 |
| 大图像传输延迟 | 中 | 缩略图预览，分块传输 |
| 工作流复杂度 | 中 | 简化模式，预设模板 |

## 9. 时间估算

| 阶段 | 预计时间 |
|------|----------|
| API 客户端开发 | 2-3 天 |
| 工作流转换层 | 2-3 天 |
| UI 组件适配 | 2-3 天 |
| 配置和环境 | 0.5 天 |
| 状态管理更新 | 1-2 天 |
| 测试和调试 | 2-3 天 |
| **总计** | **10-15 天** |

## 10. 后续优化

### 10.1 性能优化
- **工作流缓存**: 本地存储常用工作流配置，减少网络请求
- **图像预加载**: 智能预加载下一张预览图，提升浏览体验
- **WebSocket 消息批处理**: 合并高频消息，减少渲染压力
- **虚拟滚动**: 大量历史记录时使用虚拟列表
- **懒加载**: 节点组件按需加载

### 10.2 工作流模板库与灵感库

#### 模板库功能
- **预设模板**: 内置常用工作流模板
  - 文生图基础模板
  - 图生图模板
  - 局部重绘模板
  - 人像美化模板
  - 风格迁移模板
  - 批量处理模板
- **用户模板**: 保存个人常用工作流为模板
- **模板分类**: 按用途、模型类型、复杂度分类
- **模板搜索**: 关键词搜索、标签筛选

#### 灵感库功能
- **社区作品展示**: 展示优秀生成作品及其工作流
- **一键复刻**: 点击即可加载相同工作流配置
- **参数透明**: 完整展示 prompt、参数设置
- **收藏功能**: 收藏喜欢的作品和工作流
- **分享功能**: 分享自己的作品和工作流

#### 技术实现
```
/templates
  /builtin          # 内置模板 JSON
  /user             # 用户自定义模板
/inspiration
  /gallery          # 作品展示
  /workflows        # 工作流分享
```

### 10.3 暗色主题优化

#### 主题系统
- **CSS 变量系统**: 统一的颜色变量管理
- **主题切换**: 支持亮色/暗色/跟随系统
- **自定义主题**: 用户可自定义强调色

#### 暗色主题设计规范
| 元素 | 亮色模式 | 暗色模式 |
|------|----------|----------|
| 背景 | #FFFFFF | #0D0D0D |
| 次级背景 | #F5F5F5 | #1A1A1A |
| 卡片背景 | #FFFFFF | #242424 |
| 边框 | #E5E5E5 | #333333 |
| 主文字 | #171717 | #FAFAFA |
| 次级文字 | #737373 | #A3A3A3 |
| 强调色 | #3B82F6 | #60A5FA |
| 成功色 | #22C55E | #4ADE80 |
| 警告色 | #F59E0B | #FBBF24 |
| 错误色 | #EF4444 | #F87171 |

#### 节点颜色适配
- 节点边框和标题在暗色模式下调整对比度
- 连接线颜色优化
- 选中状态高亮

### 10.4 资产库管理

#### 模型资产
- **模型浏览器**: 可视化浏览已安装模型
- **模型信息**: 显示模型名称、类型、大小、来源
- **模型预览**: 展示模型示例图
- **模型分类**: Checkpoint / LoRA / VAE / Embedding / ControlNet
- **模型搜索**: 按名称、类型、标签搜索
- **模型管理**: 安装、删除、更新模型

#### 图像资产
- **生成历史**: 完整的生成历史记录
- **图像管理**: 收藏、删除、导出
- **图像搜索**: 按 prompt、参数搜索
- **批量操作**: 批量下载、删除

#### 其他资产
- **预设管理**: 保存常用参数预设
- **风格库**: 预设风格 prompt
- **角色库**: 保存角色设定和参考图

#### 资产库技术架构
```
/assets
  /models
    /checkpoints    # 主模型
    /loras          # LoRA 模型
    /vae            # VAE 模型
    /embeddings     # Embedding
    /controlnet     # ControlNet 模型
  /images
    /output         # 输出图像
    /input          # 输入图像
    /temp           # 临时文件
  /presets          # 参数预设
  /styles           # 风格库
```

### 10.5 API 管理与监控

#### API 配置管理
- **多后端支持**: 配置多个 ComfyUI 实例
- **负载均衡**: 自动选择空闲实例
- **连接配置**: URL、超时、重试策略
- **认证管理**: API Key 管理（如需要）

#### 监控面板
- **服务器状态**: CPU、GPU、内存使用率
- **队列状态**: 当前任务、等待队列
- **执行统计**: 成功率、平均耗时
- **错误日志**: 详细的错误记录和追踪

#### API 使用统计
- **调用次数**: 按时间段统计
- **模型使用**: 各模型使用频率
- **性能分析**: 响应时间分布

#### 技术实现
```typescript
interface APIManager {
  // 实例管理
  addInstance(config: InstanceConfig): void;
  removeInstance(id: string): void;
  getInstances(): Instance[];
  
  // 负载均衡
  selectInstance(): Instance;
  
  // 监控
  getStats(): Promise<ServerStats>;
  getQueue(): Promise<QueueInfo>;
  getHistory(limit: number): Promise<HistoryItem[]>;
}
```

### 10.6 其他优化

1. **拖拽导入工作流**: 支持拖拽 JSON 文件导入
2. **快捷键支持**: 完整的键盘快捷键系统
3. **撤销/重做**: 工作流编辑历史
4. **自动保存**: 防止意外丢失
5. **导出功能**: 导出工作流 JSON、图像
6. **多语言支持**: i18n 国际化

## 11. 结论

本计划将 Creativeworkflowapp 的现代 React UI 与 AI-FLOW (ComfyUI) 的强大后端能力相结合，创建一个功能完整、用户友好的 AI 图像生成工作流应用。通过分阶段实施，可以逐步完成集成，同时保持系统的稳定性和可维护性。
